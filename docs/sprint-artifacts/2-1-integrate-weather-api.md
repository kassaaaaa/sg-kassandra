# Story 2.1: Implement Weather API Poller & Caching

Status: ready-for-dev

## Story

As a **System**,
I want **to fetch and cache real-time weather data from OpenWeatherMap**,
so that **the scheduling engine can make informed, wind-dependent decisions without exceeding API rate limits or incurring high costs**.

## Acceptance Criteria

(Source: `docs/sprint-artifacts/tech-spec-epic-2.md` - Story 2.1)

1.  **Edge Function Deployment:** A Supabase Edge Function named `weather-poller` is deployed and accessible via authenticated invocation.
2.  **External Integration:** The function successfully fetches weather data (wind speed, direction, gust) from the OpenWeatherMap One Call API 3.0 for the school's specific geographic coordinates.
3.  **Caching Mechanism:**
    - Successful API responses are stored in the `weather_cache` database table.
    - Subsequent requests within a configurable time window (default: 1 hour) return the stored data from `weather_cache` instead of calling the external API.
4.  **Data Structure:** The cached data includes a JSON snapshot of the weather conditions and a timestamp of when it was fetched.
5.  **Error Handling:** The function handles external API failures gracefully (e.g., by returning the last known good cache if available, or a structured error code).

## Tasks / Subtasks

- [ ] Task 1: Database Schema Setup (AC: 3, 4)
  - [ ] Create migration for `weather_cache` table.
  - [ ] Schema: `id` (BigInt), `location` (JSON/String), `forecast_time` (TIMESTAMPTZ), `data` (JSONB), `created_at` (TIMESTAMPTZ).
  - [ ] Enable RLS (Service Role only for write, Authenticated/Service for read).
- [ ] Task 2: Environment Configuration (AC: 2)
  - [ ] Configure OpenWeatherMap API Key in Supabase Vault/Secrets.
  - [ ] Define school coordinates (Lat/Lon) as environment variables or config constants.
- [ ] Task 3: Implement Edge Function `weather-poller` (AC: 1, 2, 3, 5)
  - [ ] Initialize function using Supabase CLI.
  - [ ] Implement `fetchWeather` logic (External Call).
  - [ ] Implement `getWeather` logic (Check Cache -> Fetch if stale -> Save to Cache -> Return).
  - [ ] Handle API errors and edge cases.
- [ ] Task 4: Testing & Verification (AC: 2, 3, 5)
  - [ ] Create unit tests for the caching logic (mocking the DB and API).
  - [ ] Create an integration test invocation script.
  - [ ] Verify rate limiting protection (ensure multiple rapid calls result in 1 API hit).

## Dev Notes

- **Architecture:** Uses the **Cache-first** pattern defined in `docs/fase-3-solution/architecture.md`.
- **Secrets:** API keys must NEVER be committed. Use `supabase secrets set` and access via `Deno.env.get()`.
- **Edge Function:**
  - Use Deno runtime.
  - Use `service_role` client for DB writes to `weather_cache` if RLS is strict.
- **Table Schema:**
    ```sql
    create table weather_cache (
      id bigint generated by default as identity primary key,
      location text not null, -- generic identifier like 'main_beach'
      data jsonb not null,    -- the OWM response payload
      created_at timestamp with time zone default now() not null,
      valid_until timestamp with time zone generated always as (created_at + interval '1 hour') stored
    );
    ```
- **Dependencies:** `tech-spec-epic-2.md` mentions `weather-poller` ownership by Backend.

### Project Structure Notes

- **Functions:** Place in `supabase/functions/weather-poller/`.
- **Migrations:** Place in `supabase/migrations/`.
- **Tests:** Place Edge Function tests in `supabase/functions/weather-poller/__tests__/` or `tests/integration/` depending on the test runner strategy for Deno.

### Learnings from Previous Story

**From Story 1.8 (Status: done)**

- **Service Pattern**: While 1.8 used Next.js `lib/` services, this story introduces **Supabase Edge Functions**. We must ensure the pattern for calling these from the frontend (if needed later) or other functions matches the project standards.
- **Validation**: 1.8 used `zod`. We should continue using `zod` for validating external API responses within the Edge Function to ensure data integrity before caching.
- **RLS**: 1.8 emphasized RLS compliance. Ensure the `weather_cache` table has appropriate policies (likely read-only for public/anon if used by frontend, or restricted to service_role if only used by scheduling engine).

[Source: docs/sprint-artifacts/1-8-instructor-availability-management.md]

### References

- **Tech Spec:** `docs/sprint-artifacts/tech-spec-epic-2.md` (Story 2.1)
- **Architecture:** `docs/fase-3-solution/architecture.md` (Section 3 & 4)

## Dev Agent Record

### Context Reference
- docs/sprint-artifacts/2-1-integrate-weather-api.context.xml

### Agent Model Used
Gemini-2.5-Flash

### Debug Log References

### Completion Notes List

### File List

## Change Log

| Date | Author | Description |
|---|---|---|
| 2025-12-07 | Bob (SM) | Initial Draft created |
| 2025-12-07 | Bob (SM) | Added Change Log section per validation |
