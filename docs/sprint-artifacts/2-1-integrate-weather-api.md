# Story 2.1: Implement Weather API Poller & Caching

Status: in progress

## Story

As a **System**,
I want **to fetch and cache real-time weather data from OpenWeatherMap**,
so that **the scheduling engine can make informed, wind-dependent decisions without exceeding API rate limits or incurring high costs**.

## Acceptance Criteria

(Source: `docs/sprint-artifacts/tech-spec-epic-2.md` - Story 2.1)

1.  **Edge Function Deployment:** A Supabase Edge Function named `weather-poller` is deployed and accessible via authenticated invocation.
2.  **External Integration:** The function successfully fetches weather data (wind speed, direction, gust) from the OpenWeatherMap One Call API 3.0 for the school's specific geographic coordinates.
3.  **Caching Mechanism:**
    - Successful API responses are stored in the `weather_cache` database table.
    - Subsequent requests within a configurable time window (default: 1 hour) return the stored data from `weather_cache` instead of calling the external API.
4.  **Data Structure:** The cached data includes a JSON snapshot of the weather conditions and a timestamp of when it was fetched.
5.  **Error Handling:** The function handles external API failures gracefully (e.g., by returning the last known good cache if available, or a structured error code).

## Tasks / Subtasks

- [x] Task 1: Database Schema Setup (AC: 3, 4)
  - [x] Create migration for `weather_cache` table.
  - [x] Schema: `id` (BigInt), `location` (JSON/String), `forecast_time` (TIMESTAMPTZ), `data` (JSONB), `created_at` (TIMESTAMPTZ).
  - [x] Enable RLS (Service Role only for write, Authenticated/Service for read).
- [x] Task 2: Environment Configuration (AC: 2)
  - [x] Configure OpenWeatherMap API Key in Supabase Vault/Secrets.
  - [x] Define school coordinates (Lat/Lon) as environment variables or config constants.
- [x] Task 3: Implement Edge Function `weather-poller` (AC: 1, 2, 3, 5)
  - [x] Initialize function using Supabase CLI.
  - [x] Implement `fetchWeather` logic (External Call).
  - [x] Implement `getWeather` logic (Check Cache -> Fetch if stale -> Save to Cache -> Return).
  - [x] Handle API errors and edge cases.
- [ ] Task 4: Testing & Verification (AC: 2, 3, 5)
  - [x] Create unit tests for the caching logic (mocking the DB and API).
  - [ ] Create an integration test invocation script.
  - [ ] Verify rate limiting protection (ensure multiple rapid calls result in 1 API hit).

## Dev Notes

- **Architecture:** Uses the **Cache-first** pattern defined in `docs/fase-3-solution/architecture.md`.
- **Secrets:** API keys must NEVER be committed. Use `supabase secrets set` and access via `Deno.env.get()`.
- **Edge Function:**
  - Use Deno runtime.
  - Use `service_role` client for DB writes to `weather_cache` if RLS is strict.
- **Table Schema:**
    ```sql
    create table weather_cache (
      id bigint generated by default as identity primary key,
      location text not null, -- generic identifier like 'main_beach'
      data jsonb not null,    -- the OWM response payload
      created_at timestamp with time zone default now() not null,
      valid_until timestamp with time zone generated always as (created_at + interval '1 hour') stored
    );
    ```
- **Dependencies:** `tech-spec-epic-2.md` mentions `weather-poller` ownership by Backend.

### Project Structure Notes

- **Functions:** Place in `supabase/functions/weather-poller/`.
- **Migrations:** Place in `supabase/migrations/`.
- **Tests:** Place Edge Function tests in `supabase/functions/weather-poller/__tests__/` or `tests/integration/` depending on the test runner strategy for Deno.

### Learnings from Previous Story

**From Story 1.8 (Status: done)**

- **Service Pattern**: While 1.8 used Next.js `lib/` services, this story introduces **Supabase Edge Functions**. We must ensure the pattern for calling these from the frontend (if needed later) or other functions matches the project standards.
- **Validation**: 1.8 used `zod`. We should continue using `zod` for validating external API responses within the Edge Function to ensure data integrity before caching.
- **RLS**: 1.8 emphasized RLS compliance. Ensure the `weather_cache` table has appropriate policies (likely read-only for public/anon if used by frontend, or restricted to service_role if only used by scheduling engine).

[Source: docs/sprint-artifacts/1-8-instructor-availability-management.md]

### References

- **Tech Spec:** `docs/sprint-artifacts/tech-spec-epic-2.md` (Story 2.1)
- **Architecture:** `docs/fase-3-solution/architecture.md` (Section 3 & 4)

## Dev Agent Record

### Context Reference
- docs/sprint-artifacts/2-1-integrate-weather-api.context.xml

### Agent Model Used
Gemini-2.5-Flash

### Debug Log References

### Completion Notes List
- The Deno tests for the `weather-poller` edge function could not be run because the `deno` command was not found in the environment. The tests have been written and the edge function has been refactored to be testable, but the tests themselves have not been executed.

### File List
- `supabase/migrations/20251207000000_create_weather_cache.sql`
- `docs/sprint-artifacts/2-1-environment-config-instructions.md`
- `supabase/functions/weather-poller/index.ts`
- `supabase/functions/weather-poller/__tests__/index.test.ts`


## Change Log

| Date | Author | Description |
|---|---|---|
| 2025-12-07 | Bob (SM) | Initial Draft created |
| 2025-12-07 | Bob (SM) | Added Change Log section per validation |
---

## Senior Developer Review (AI)

- **Reviewer**: Amelia (Developer Agent)
- **Date**: 2025-12-07
- **Outcome**: <span style="color:red; font-weight:bold;">Blocked</span>
  - **Justification**: The review is blocked due to a **HIGH severity** security finding. A secret (API key) has been hardcoded and committed to the repository. This must be removed and the git history cleansed before the story can be approved.

### Summary
The core implementation of the weather polling and caching mechanism is functionally correct and aligns with the specified architecture. However, the review is **BLOCKED** due to a critical security vulnerability. Additionally, a medium-severity deviation from the required error handling logic was found, and several process gaps were noted regarding task tracking and testing.

### Key Findings (by severity)

- **[HIGH] Exposed Secret in Documentation**: The OpenWeatherMap API key is hardcoded in the setup instructions file (`docs/sprint-artifacts/2-1-environment-config-instructions.md`). Secrets must never be committed to version control.
- **[MEDIUM] Incorrect Error Handling Fallback**: The function does not return stale cached data if the external API fails, which contradicts the resiliency requirement in AC #5. It currently returns a generic 500 error immediately.
- **[LOW] Incomplete Testing**: While unit tests were written, the developer noted they could not be executed. Furthermore, the required integration tests and rate-limit verification tests were not provided.
- **[PROCESS] Inaccurate Task Status**: All implementation tasks were completed, but none were marked as complete (`[x]`) in the story's "Tasks / Subtasks" section. This misrepresents the actual progress of the story.

### Acceptance Criteria Coverage

| AC# | Description | Status | Evidence |
| :--- | :--- | :--- | :--- |
| 1 | Edge Function Deployment | **IMPLEMENTED** | `supabase/functions/weather-poller/index.ts` exists. |
| 2 | External Integration | **IMPLEMENTED** | `fetchWeather` function correctly calls the OWM API. |
| 3 | Caching Mechanism | **IMPLEMENTED** | `handleRequest` checks cache age before fetching new data. |
| 4 | Data Structure | **IMPLEMENTED** | `supabase/migrations/..._create_weather_cache.sql` matches spec. |
| 5 | Error Handling | **PARTIAL** | `try/catch` block exists but does not return stale cache on fetch failure. |

**Summary: 4 of 5 acceptance criteria fully implemented.**

### Task Completion Validation

| Task | Marked As | Verified As | Evidence |
| :--- | :--- | :--- | :--- |
| 1: DB Schema | Incomplete `[ ]` | **VERIFIED COMPLETE** | `..._create_weather_cache.sql` is correct. |
| 2: Env Config | Incomplete `[ ]` | **VERIFIED COMPLETE** | `...-config-instructions.md` and env var usage are correct. |
| 3: Edge Func | Incomplete `[ ]` | **VERIFIED COMPLETE** | `index.ts` contains the required logic. |
| 4: Testing | Incomplete `[ ]` | **PARTIAL** | Unit tests written but not run; integration tests missing. |

**Summary: 3 of 4 completed tasks were verified. All completed tasks were falsely marked as incomplete.**

### Test Coverage and Gaps
- **Unit Tests:** Written for caching logic but were not executed.
- **Integration Tests:** Missing. No script was provided to verify the live function against the database.
- **E2E / Rate-Limit Tests:** Missing. No verification was provided for the rate-limiting protection.

### Architectural Alignment
The implementation correctly follows the **Cache-first** pattern defined in the architecture document. It properly utilizes a Supabase Edge Function for external integration.

### Security Notes
The hardcoded API key is a critical vulnerability. The key should be immediately rotated, removed from the file, and the commit history should be cleansed to remove any trace of the secret.

### Action Items

**Code Changes Required:**
- [ ] **[High]** Remove the hardcoded API key from `docs/sprint-artifacts/2-1-environment-config-instructions.md` and instruct the user to purge it from git history. **(BLOCKER)**
- [ ] **[Medium]** Modify the error handling logic in `supabase/functions/weather-poller/index.ts` to return the last valid cached data when an external API fetch fails (AC #5).
- [ ] **[Low]** Ensure all tests in `supabase/functions/weather-poller/__tests__/index.test.ts` can be executed successfully within the development environment.

**Process Changes Required:**
- [ ] **[Process]** Update the "Tasks / Subtasks" section in `docs/sprint-artifacts/2-1-integrate-weather-api.md` to accurately reflect the completed work.